<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnnotPdf E2E Tests - Stress Testing</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
    h1 { color: #333; border-bottom: 3px solid #4caf50; padding-bottom: 10px; }
    .test-section { background: white; margin-bottom: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .test-section h2 { color: #4caf50; margin-top: 0; }
    .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid; }
    .test-pass { background-color: #d4edda; color: #155724; border-color: #28a745; }
    .test-fail { background-color: #f8d7da; color: #721c24; border-color: #dc3545; }
    button { margin: 5px; padding: 12px 24px; font-size: 14px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 4px; }
    button:hover { background: #45a049; }
    #test-container { margin-top: 20px; padding: 20px; border: 2px dashed #ccc; border-radius: 4px; min-height: 500px; background: #fafafa; }
    .visual-test { margin: 20px 0; padding: 15px; border: 2px solid #4caf50; border-radius: 4px; background: white; }
  </style>
</head>
<body>
  <h1>üéØ AnnotPdf E2E Tests: Stress Testing</h1>

  <div class="test-section">
    <h2>Test Controls</h2>
    <button id="run-all">‚ñ∂Ô∏è Run All Tests</button>
    <button id="clear-results">üóëÔ∏è Clear Results</button>
  </div>

  <div class="test-section">
    <h2>Test Results</h2>
    <div id="results"></div>
  </div>

  <div class="test-section">
    <h2>Test Container</h2>
    <div id="test-container"></div>
  </div>

  <script type="module">
    import React from 'react';
    import { createRoot } from 'react-dom/client';
    import { AnnotPdf } from '../../../src/index.js';
    import { logTest, clearResults, showSummary, sleep, measureTimeAsync } from '../fixtures/testHelpers.js';
    import { allAnnotations } from '../fixtures/testAnnotations.js';

    const results = document.getElementById('results');
    const container = document.getElementById('test-container');

    async function runTests() {
      clearResults(results);
      container.innerHTML = '';

      console.log('\n========== E2E TESTS: STRESS TESTING ==========\n');

      // STRESS TEST 1: Rapid prop updates
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        const root = createRoot(testDiv);

        const { duration } = await measureTimeAsync('Rapid prop updates', async () => {
          for (let i = 0; i < 50; i++) {
            root.render(React.createElement(AnnotPdf, {
              pdfUrl: '/pdfFile/sample.pdf',
              currentTime: i * 0.1,
              scale: 1.5 + (i % 10) * 0.1
            }));
            await sleep(20);
          }
        });

        const passed = duration < 5000;  // Should complete in under 5 seconds
        logTest(results, 'Rapid prop updates (50 updates)', passed,
          `Completed in ${duration.toFixed(0)}ms`);

        root.unmount();
      } catch (error) {
        logTest(results, 'Rapid prop updates', false, error.message);
      }

      // STRESS TEST 2: Multiple mount/unmount cycles
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        const { duration } = await measureTimeAsync('Mount/unmount cycles', async () => {
          for (let i = 0; i < 10; i++) {
            const root = createRoot(testDiv);
            root.render(React.createElement(AnnotPdf, {
              pdfUrl: '/pdfFile/sample.pdf',
              annotations: allAnnotations
            }));
            await sleep(100);
            root.unmount();
            await sleep(50);
          }
        });

        logTest(results, 'Multiple mount/unmount cycles (10 cycles)', true,
          `Completed in ${duration.toFixed(0)}ms`);

      } catch (error) {
        logTest(results, 'Multiple mount/unmount cycles', false, error.message);
      }

      // STRESS TEST 3: Large annotation set
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        // Create many annotations
        const manyAnnotations = [];
        for (let i = 0; i < 50; i++) {
          manyAnnotations.push({
            id: `stress-highlight-${i}`,
            type: 'highlight',
            page: 1,
            start: i * 0.2,
            end: (i + 1) * 0.2,
            quads: [{ x: 0.1 + (i % 5) * 0.15, y: 0.1 + Math.floor(i / 5) * 0.1, w: 0.1, h: 0.03 }],
            style: { color: 'rgba(255, 255, 0, 0.3)' }
          });
        }

        const root = createRoot(testDiv);

        const { duration } = await measureTimeAsync('Large annotation set', async () => {
          root.render(React.createElement(AnnotPdf, {
            pdfUrl: '/pdfFile/sample.pdf',
            annotations: manyAnnotations,
            currentTime: 5
          }));
          await sleep(2000);
        });

        const passed = duration < 5000;
        logTest(results, 'Large annotation set (50 annotations)', passed,
          `Rendered in ${duration.toFixed(0)}ms`);

        root.unmount();
      } catch (error) {
        logTest(results, 'Large annotation set', false, error.message);
      }

      // STRESS TEST 4: Continuous timeline playback
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        const root = createRoot(testDiv);

        const { duration } = await measureTimeAsync('Continuous playback', async () => {
          for (let t = 0; t <= 10; t += 0.1) {
            root.render(React.createElement(AnnotPdf, {
              pdfUrl: '/pdfFile/sample.pdf',
              annotations: allAnnotations,
              currentTime: t
            }));
            await sleep(30);  // Simulate 30fps
          }
        });

        const passed = duration < 5000;
        logTest(results, 'Continuous timeline playback (0‚Üí10s)', passed,
          `Completed in ${duration.toFixed(0)}ms`);

        root.unmount();
      } catch (error) {
        logTest(results, 'Continuous timeline playback', false, error.message);
      }

      // STRESS TEST 5: Rapid page switching
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        const root = createRoot(testDiv);

        const { duration } = await measureTimeAsync('Rapid page switching', async () => {
          for (let i = 0; i < 20; i++) {
            root.render(React.createElement(AnnotPdf, {
              pdfUrl: '/pdfFile/sample.pdf',
              page: (i % 2) + 1,
              annotations: allAnnotations
            }));
            await sleep(100);
          }
        });

        logTest(results, 'Rapid page switching (20 switches)', true,
          `Completed in ${duration.toFixed(0)}ms`);

        root.unmount();
      } catch (error) {
        logTest(results, 'Rapid page switching', false, error.message);
      }

      // STRESS TEST 6: Scale changes under load
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        const root = createRoot(testDiv);

        const scales = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0];

        const { duration } = await measureTimeAsync('Scale changes', async () => {
          for (let i = 0; i < 12; i++) {
            root.render(React.createElement(AnnotPdf, {
              pdfUrl: '/pdfFile/sample.pdf',
              scale: scales[i % scales.length],
              annotations: allAnnotations,
              currentTime: 3
            }));
            await sleep(200);
          }
        });

        logTest(results, 'Scale changes under load (12 changes)', true,
          `Completed in ${duration.toFixed(0)}ms`);

        root.unmount();
      } catch (error) {
        logTest(results, 'Scale changes under load', false, error.message);
      }

      // STRESS TEST 7: Memory stability (long session)
      try {
        const testDiv = document.createElement('div');
        testDiv.className = 'visual-test';
        container.appendChild(testDiv);

        const root = createRoot(testDiv);

        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          annotations: allAnnotations
        }));

        const { duration } = await measureTimeAsync('Long session simulation', async () => {
          for (let cycle = 0; cycle < 5; cycle++) {
            // Simulate various operations
            for (let t = 0; t <= 10; t += 1) {
              root.render(React.createElement(AnnotPdf, {
                pdfUrl: '/pdfFile/sample.pdf',
                page: (cycle % 2) + 1,
                scale: 1.5 + (cycle * 0.2),
                annotations: allAnnotations,
                currentTime: t
              }));
              await sleep(50);
            }
          }
        });

        logTest(results, 'Memory stability (long session)', true,
          `5 cycles completed in ${duration.toFixed(0)}ms`);

        root.unmount();
      } catch (error) {
        logTest(results, 'Memory stability', false, error.message);
      }

      showSummary(results);
    }

    document.getElementById('run-all').addEventListener('click', runTests);
    document.getElementById('clear-results').addEventListener('click', () => {
      clearResults(results);
      container.innerHTML = '';
    });

    console.log('Page loaded. Click "Run All Tests" to start.');
  </script>
</body>
</html>
