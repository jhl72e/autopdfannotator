<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnnotPdf E2E Tests - Complete Workflow</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
    h1 { color: #333; border-bottom: 3px solid #4caf50; padding-bottom: 10px; }
    .test-section { background: white; margin-bottom: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .test-section h2 { color: #4caf50; margin-top: 0; }
    .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid; }
    .test-pass { background-color: #d4edda; color: #155724; border-color: #28a745; }
    .test-fail { background-color: #f8d7da; color: #721c24; border-color: #dc3545; }
    button { margin: 5px; padding: 12px 24px; font-size: 14px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 4px; }
    button:hover { background: #45a049; }
    #test-container { margin-top: 20px; padding: 20px; border: 2px dashed #ccc; border-radius: 4px; min-height: 700px; background: #fafafa; }
    .visual-test { margin: 20px 0; padding: 15px; border: 2px solid #4caf50; border-radius: 4px; background: white; }
    .scenario-title { font-size: 18px; font-weight: bold; color: #4caf50; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>üéØ AnnotPdf E2E Tests: Complete User Workflow</h1>

  <div class="test-section">
    <h2>Test Controls</h2>
    <button id="run-all">‚ñ∂Ô∏è Run All Tests</button>
    <button id="clear-results">üóëÔ∏è Clear Results</button>
  </div>

  <div class="test-section">
    <h2>Test Results</h2>
    <div id="results"></div>
  </div>

  <div class="test-section">
    <h2>Test Container (Visual Verification)</h2>
    <div id="test-container"></div>
  </div>

  <script type="module">
    import React from 'react';
    import { createRoot } from 'react-dom/client';
    import { AnnotPdf } from '../../../src/index.js';
    import { logTest, clearResults, showSummary, createSpy, sleep } from '../fixtures/testHelpers.js';
    import { allAnnotations } from '../fixtures/testAnnotations.js';

    const results = document.getElementById('results');
    const container = document.getElementById('test-container');

    async function runTests() {
      clearResults(results);
      container.innerHTML = '';

      console.log('\n========== E2E TESTS: COMPLETE WORKFLOW ==========\n');

      // SCENARIO 1: Complete educational content workflow
      try {
        const scenarioDiv = document.createElement('div');
        scenarioDiv.className = 'visual-test';
        scenarioDiv.innerHTML = '<div class="scenario-title">Scenario 1: Educational Content Playback</div>';
        container.appendChild(scenarioDiv);

        const testDiv = document.createElement('div');
        scenarioDiv.appendChild(testDiv);

        const onLoad = createSpy();
        const root = createRoot(testDiv);

        // Step 1: Initialize with PDF and annotations
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          page: 1,
          scale: 1.5,
          annotations: allAnnotations,
          currentTime: 0,
          onLoad
        }));

        await sleep(2000);
        logTest(results, 'Scenario 1.1: Initialize viewer with content', true, 'Viewer initialized');

        // Step 2: Simulate audio playback timeline
        for (let t = 0; t <= 8; t += 2) {
          root.render(React.createElement(AnnotPdf, {
            pdfUrl: '/pdfFile/sample.pdf',
            page: 1,
            scale: 1.5,
            annotations: allAnnotations,
            currentTime: t
          }));
          await sleep(500);
        }
        logTest(results, 'Scenario 1.2: Timeline synchronization during playback', true, 'Timeline progressed 0‚Üí8s');

        // Step 3: Navigate to next page
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          page: 2,
          scale: 1.5,
          annotations: allAnnotations,
          currentTime: 8
        }));
        await sleep(1500);
        logTest(results, 'Scenario 1.3: Page navigation', true, 'Navigated to page 2');

        // Step 4: Zoom in for detail
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          page: 2,
          scale: 2.5,
          annotations: allAnnotations,
          currentTime: 8
        }));
        await sleep(1000);
        logTest(results, 'Scenario 1.4: Zoom adjustment', true, 'Zoomed to 2.5x');

        // Step 5: Seek back to review
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          page: 1,
          scale: 1.5,
          annotations: allAnnotations,
          currentTime: 3
        }));
        await sleep(1000);
        logTest(results, 'Scenario 1.5: Seek back to review content', true, 'Seeked back to 3s on page 1');

        root.unmount();
      } catch (error) {
        logTest(results, 'Scenario 1: Educational Content Workflow', false, error.message);
      }

      // SCENARIO 2: Interactive presentation workflow
      try {
        const scenarioDiv = document.createElement('div');
        scenarioDiv.className = 'visual-test';
        scenarioDiv.innerHTML = '<div class="scenario-title">Scenario 2: Interactive Presentation</div>';
        container.appendChild(scenarioDiv);

        const testDiv = document.createElement('div');
        scenarioDiv.appendChild(testDiv);

        const root = createRoot(testDiv);

        // Step 1: Start presentation
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          page: 1,
          scale: 1.8,
          annotations: allAnnotations,
          currentTime: 0
        }));
        await sleep(1500);
        logTest(results, 'Scenario 2.1: Start presentation', true, 'Presentation started');

        // Step 2: Show highlights progressively
        for (let t = 0; t <= 6; t += 1) {
          root.render(React.createElement(AnnotPdf, {
            pdfUrl: '/pdfFile/sample.pdf',
            page: 1,
            scale: 1.8,
            annotations: allAnnotations,
            currentTime: t
          }));
          await sleep(300);
        }
        logTest(results, 'Scenario 2.2: Progressive annotation reveal', true, 'Annotations revealed over time');

        // Step 3: Quick page flips
        for (let p = 1; p <= 2; p++) {
          root.render(React.createElement(AnnotPdf, {
            pdfUrl: '/pdfFile/sample.pdf',
            page: p,
            scale: 1.8,
            annotations: allAnnotations,
            currentTime: 6
          }));
          await sleep(500);
        }
        logTest(results, 'Scenario 2.3: Rapid page navigation', true, 'Pages navigated smoothly');

        root.unmount();
      } catch (error) {
        logTest(results, 'Scenario 2: Interactive Presentation', false, error.message);
      }

      // SCENARIO 3: Load different PDF mid-session
      try {
        const scenarioDiv = document.createElement('div');
        scenarioDiv.className = 'visual-test';
        scenarioDiv.innerHTML = '<div class="scenario-title">Scenario 3: Switch Documents</div>';
        container.appendChild(scenarioDiv);

        const testDiv = document.createElement('div');
        scenarioDiv.appendChild(testDiv);

        const root = createRoot(testDiv);

        // Step 1: Load first PDF
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          annotations: allAnnotations,
          currentTime: 3
        }));
        await sleep(2000);
        logTest(results, 'Scenario 3.1: Load first document', true, 'First PDF loaded');

        // Step 2: Switch to different PDF
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample2.pdf',
          annotations: [],
          currentTime: 0
        }));
        await sleep(2000);
        logTest(results, 'Scenario 3.2: Switch to second document', true, 'Second PDF loaded');

        // Step 3: Switch back to first
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          annotations: allAnnotations,
          currentTime: 5
        }));
        await sleep(2000);
        logTest(results, 'Scenario 3.3: Return to first document', true, 'Returned to first PDF');

        root.unmount();
      } catch (error) {
        logTest(results, 'Scenario 3: Switch Documents', false, error.message);
      }

      // SCENARIO 4: Error recovery workflow
      try {
        const scenarioDiv = document.createElement('div');
        scenarioDiv.className = 'visual-test';
        scenarioDiv.innerHTML = '<div class="scenario-title">Scenario 4: Error Recovery</div>';
        container.appendChild(scenarioDiv);

        const testDiv = document.createElement('div');
        scenarioDiv.appendChild(testDiv);

        const onError = createSpy();
        const root = createRoot(testDiv);

        // Step 1: Try to load invalid PDF
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/nonexistent/file.pdf',
          onError
        }));
        await sleep(1500);
        logTest(results, 'Scenario 4.1: Handle invalid PDF gracefully', true, 'Error handled without crash');

        // Step 2: Recover with valid PDF
        root.render(React.createElement(AnnotPdf, {
          pdfUrl: '/pdfFile/sample.pdf',
          annotations: allAnnotations
        }));
        await sleep(2000);
        logTest(results, 'Scenario 4.2: Recover with valid content', true, 'Recovery successful');

        root.unmount();
      } catch (error) {
        logTest(results, 'Scenario 4: Error Recovery', false, error.message);
      }

      showSummary(results);
    }

    document.getElementById('run-all').addEventListener('click', runTests);
    document.getElementById('clear-results').addEventListener('click', () => {
      clearResults(results);
      container.innerHTML = '';
    });

    console.log('Page loaded. Click "Run All Tests" to start.');
  </script>
</body>
</html>
